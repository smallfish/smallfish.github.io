<!DOCTYPE html>

<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Fabric 部署工具 | blog // smallfish</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="/css/main.min.e34415025514319010e741089e6920454053855755ba465f66943ad102d2cb08.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">blog // smallfish</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">About</a>
  
    <a class="color-link nav-link" href="/tags/">Tags</a>
  
    <a class="color-link nav-link" href="/archives/">Archives</a>
  
  <a class="color-link nav-link" href="/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    
    <a class="social-icon" href="https://twitter.com/smallfishxy" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/smallfish" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




    <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
    <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js" integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin="anonymous"></script>
</footer>

</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">Fabric 部署工具</h1>
    
    <time>2012-08-30</time>
    
    <div>
        <p>
        <p>Fabric 是基于 SSH 协议的 Python 工具，相比传统的 ssh/scp 方式，用 Python 的语法写管理命令更易读也更容易扩展，管理单台或者多台机器犹如本地操作一般。</p>
<p>官网地址：<a href="http://fabfile.org">http://fabfile.org</a> 安装方法这里不在说明，推荐使用：pip 或者 easy_install 来安装。</p>
<p>传统维护方法：</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ssh x.x.x.x <span style="color:#e6db74">&#39;uname -a&#39;</span> -- 输出略</span></span></code></pre></div>
Fabric 示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat fabfile.py
</span></span><span style="display:flex;"><span>from fabric.api import run
</span></span><span style="display:flex;"><span>def uname<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>    run<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;uname -a&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ fab -H x.x.x.x uname -- 输出略</span></span></code></pre></div>
<p>肉眼直观看上去，貌似比 ssh 方式要写不少代码，但是基于 ssh 方式中间可控环节比较少，例如：你想判断某服务是否已经启动，没有启动则执行启动等等操作。ssh 命令式的做法稍显麻烦。（当然龌龊一点可以在被操作机器上写好一个脚本，ssh 调用这个脚本）</p>
<p>说几个 Fabric 的优点吧：</p>
<ol>
<li>角色定义</li>
<li>代码易读</li>
<li>封装了本地、远程操作（还需要自己封装system/popen/ssh操作么？）</li>
<li>参数灵活（动态指定 host/role 等，还有并发执行 <em>基于multiprocessing</em> ）</li>
<li>完整的日志输出</li>
</ol>
<p>罗列的这些，其实日常工作里基本都有类似的封装了，但是有现成的一个成熟的工具，干啥不用呢？对吧。</p>
<p>常用的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>env.host           -- 主机ip，当然也可以-H参数指定
</span></span><span style="display:flex;"><span>env.password       -- 密码，打好通道的请无视
</span></span><span style="display:flex;"><span>env.roledefs       -- 角色分组，比如：<span style="color:#f92672">{</span><span style="color:#e6db74">&#39;web&#39;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;x&#39;</span>, <span style="color:#e6db74">&#39;y&#39;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">&#39;db&#39;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">]}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fab -l             -- 显示可用的task（命令）
</span></span><span style="display:flex;"><span>fab -H             -- 指定host，支持多host逗号分开
</span></span><span style="display:flex;"><span>fab -R             -- 指定role，支持多个
</span></span><span style="display:flex;"><span>fab -P             -- 并发数，默认是串行
</span></span><span style="display:flex;"><span>fab -w             -- warn_only，默认是碰到异常直接abort退出
</span></span><span style="display:flex;"><span>fab -f             -- 指定入口文件，fab默认入口文件是：fabfile/fabfile.py
</span></span><span style="display:flex;"><span>更多请参考：fab --help</span></span></code></pre></div>
<p>常用的函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>local<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;pwd&#39;</span><span style="color:#f92672">)</span>                     -- 执行本地命令
</span></span><span style="display:flex;"><span>lcd<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/tmp&#39;</span><span style="color:#f92672">)</span>                      -- 切换本地目录
</span></span><span style="display:flex;"><span>cd<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/tmp&#39;</span><span style="color:#f92672">)</span>                       -- 切换远程目录
</span></span><span style="display:flex;"><span>run<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;uname -a&#39;</span><span style="color:#f92672">)</span>                  -- 执行远程命令
</span></span><span style="display:flex;"><span>sudo<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/etc/init.d/nginx start&#39;</span><span style="color:#f92672">)</span>  -- 执行远程sudo，注意pty选项</span></span></code></pre></div>
<p>示例1：管理远程 nginx 服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat fabfile.py
</span></span><span style="display:flex;"><span>from fabric.api import *
</span></span><span style="display:flex;"><span>@task
</span></span><span style="display:flex;"><span>def nginx_start<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; nginx start &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>sudo<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/etc/init.d/nginx start&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@task
</span></span><span style="display:flex;"><span>def nginx_stop<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; nginx stop &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    sudo<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/etc/init.d/nginx stop&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>$ fab --list      -- 查看可用命令
</span></span><span style="display:flex;"><span>Available commands:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nginx_start  nginx start 
</span></span><span style="display:flex;"><span>    nginx_stop   nginx stop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ fab -H x.x.x.x nginx_start  -- 启动 nginx</span></span></code></pre></div>
<p>示例2：基于角色</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat fabfile.py
</span></span><span style="display:flex;"><span>from fabric.api import *
</span></span><span style="display:flex;"><span>env.roledefs <span style="color:#f92672">=</span> <span style="color:#f92672">{</span><span style="color:#e6db74">&#39;nginx&#39;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;x.x.x.x&#39;</span>, <span style="color:#e6db74">&#39;y.y.y.y&#39;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">&#39;mysql&#39;</span>: <span style="color:#e6db74">&#39;z.z.z.z&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>@task
</span></span><span style="display:flex;"><span>def mysql_start<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; mysql start &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    sudo<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/etc/init.d/mysql start&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>$ fab --list      -- 查看可用命令
</span></span><span style="display:flex;"><span>Available commands:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nginx_start  nginx start 
</span></span><span style="display:flex;"><span>    nginx_stop   nginx stop
</span></span><span style="display:flex;"><span>    mysql_start  mysql start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ fab -R nginx nginx_start  -- 启动 nginx
</span></span><span style="display:flex;"><span>$ fab -R mysql mysql_start  -- 启动 mysql</span></span></code></pre></div>
<p>示例3：混合本地和远程操作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat fabfile
</span></span><span style="display:flex;"><span>def hello<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39; test hello &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    with lcd<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/tmp&#39;</span><span style="color:#f92672">)</span>:  <span style="color:#75715e"># 切换到 /tmp 目录下</span>
</span></span><span style="display:flex;"><span>        local<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;svn co http://xxx xxx&#39;</span><span style="color:#f92672">)</span> <span style="color:#75715e"># check 代码到本地</span>
</span></span><span style="display:flex;"><span>        local<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tar czf xxx.tar.gz xxx/&#39;</span><span style="color:#f92672">)</span> <span style="color:#75715e"># 压缩本地包</span>
</span></span><span style="display:flex;"><span>        put<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;xxx.tar.gz&#39;</span>, <span style="color:#e6db74">&#39;/tmp&#39;</span><span style="color:#f92672">)</span> <span style="color:#75715e"># 上传压缩包到远程 /tmp 目录下</span>
</span></span><span style="display:flex;"><span>    with cd<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/tmp&#39;</span><span style="color:#f92672">)</span>:   <span style="color:#75715e"># 切换到远程 /tmp 目录</span>
</span></span><span style="display:flex;"><span>        run<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;tar zxf xxx.tar.gz&#39;</span><span style="color:#f92672">)</span> <span style="color:#75715e"># 远程解压</span></span></span></code></pre></div>
<p>是不是看上去都是像本地一样？对吧。</p>

        </p>
    </div>
    

    

    <div class="page-footer">
        
    </div>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="/js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    
    <a class="social-icon" href="https://twitter.com/smallfishxy" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/smallfish" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
        <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
        <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js" integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin="anonymous"></script>
</footer>

    </body>
</html>